# Story 2.1: Biometric Core Library Implementation

**Status:** Approved

## Story
**As a** Backend Developer,
**I want** to encapsulate the SourceAFIS library and biometric template management into a shared module,
**so that** both the API Gateway (for validation) and Worker Nodes (for matching) use the same standard for processing fingerprints.

## Acceptance Criteria
1. **Shared Module**: A new module `packages/biometric-core` is created.
2. **SourceAFIS Wrapper**: A service wraps `SourceAFIS` to handle `FingerprintTemplate` creation from byte arrays (images) and serialization.
3. **Template DTOs**: Standardized DTOs for `BiometricSubject` (RID + Templates) are defined.
4. **Validation Logic**: Logic to validate input images (format, size) and extract templates successfully.
5. **Serialization**: Efficient serialization (Protobuf or specialized binary) of templates for storage and network transfer.

## Tasks / Subtasks
- [ ] **Module Setup**
    - [ ] Create `packages/biometric-core` (Maven/Gradle module).
    - [ ] Add `com.machinezoo.sourceafis:sourceafis:3.18.1` dependency.
- [ ] **Core Service Implementation**
    - [ ] Implement `BiometricService.createTemplate(byte[] image)`.
    - [ ] Implement `BiometricService.serialize(FingerprintTemplate template)`.
    - [ ] Implement `BiometricService.deserialize(byte[] data)`.
- [ ] **Data Structures**
    - [ ] Define `Subject` record (RID, TenantID, List<FingerprintTemplate>).
    - [ ] Implement a `Candidate` DTO (RID, Score).
- [ ] **Testing**
    - [ ] Unit tests with sample fingerprint images.
    - [ ] Verify serialization/deserialization cycle preserves matching capability.

## Dev Notes
* **Performance**: `FingerprintTemplate` creation is CPU intensive. This code must be optimized and thread-safe.
* **Compatibility**: Ensure the serialized format is compatible with what we plan to store in PostgreSQL (`bytea` column).
* **CRITICAL - Test Data**: Do not code blindly. You must use **REAL fingerprint files** (Format ISO 19794-2 or PNG/WSQ) for unit tests. Place sample `.png` fingerprints in `src/test/resources` to validate SourceAFIS behavior correctly.
