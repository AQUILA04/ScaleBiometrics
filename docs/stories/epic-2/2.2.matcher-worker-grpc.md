# Story 2.2: Matcher Worker Node (gRPC & Memory)

**Status:** Approved

## Story
**As a** Backend Developer,
**I want** to build the "Worker" service that holds templates in memory and exposes a gRPC endpoint,
**so that** it can perform high-speed 1:N matching when requested by the Master.

## Acceptance Criteria
1. **Worker Application**: A standalone Spring Boot application (`apps/worker`) is initialized.
2. **In-Memory Cache**: A thread-safe structure (e.g., `ConcurrentHashMap<TenantId, List<Subject>>`) holds fingerprint templates in RAM.
3. **gRPC Server**: The worker exposes a gRPC service defined in Protobuf (`MatchService`).
4. **Matching Logic**: Implementation of the `match(Probe)` method that scans the in-memory list for a specific Tenant and returns the top matches.
5. **Thread Management**: Matching is CPU-bound; ensure the gRPC handler offloads the scan to a dedicated Platform Thread pool.

## Tasks / Subtasks
- [ ] **Protobuf Definition**
    - [ ] Create `proto/matching.proto`: Define `MatchRequest` (TenantID, ProbeTemplate) and `MatchResponse` (List<Candidate>).
    - [ ] Configure Protobuf compilation/plugin.
- [ ] **Worker Service Setup**
    - [ ] Initialize `apps/worker` with `net.devh:grpc-server-spring-boot-starter`.
    - [ ] Implement `BiometricStore` (The in-memory cache).
- [ ] **gRPC Implementation**
    - [ ] Implement `MatchServiceImplBase`.
    - [ ] Write logic to iterate over `BiometricStore` for the requested Tenant.
    - [ ] Use `SourceAFIS` matcher to compute scores.
    - [ ] Filter results > Threshold and return top N.
- [ ] **Testing**
    - [ ] gRPC integration test: Send a probe, verify response.

## Dev Notes
* **Zero Trust/Security**: Using Perimeter Security (PLAINTEXT internally). Ensure it listens on a private interface.
* **Concurrency**: 1:N matching is an O(N) operation. Use parallel streams if beneficial.
* **CRITICAL - Context Propagation**: You MUST extract `TraceID` and `TenantID` from the incoming gRPC Metadata (Headers) and set them in the MDC/ThreadLocal context so that logs are correlated.
* **Memory Management**: Monitor Heap usage closely during tests. The cache is entirely in RAM.
