# Story 1.4: Distributed Observability & JVM Metrics

**Status:** Approved

## Story
**As a** DevOps Engineer,
**I want** to configure distributed tracing and detailed JVM metrics,
**so that** I can monitor Off-Heap memory usage and track requests across the Master-Worker cluster.

## Acceptance Criteria
1. **OpenTelemetry**: Integration of `opentelemetry-javaagent` or Spring Boot native instrumentation.
2. **Trace Context**: `TraceID` and `SpanID` must be automatically injected into logs (MDC) and propagated via Kafka headers.
3. **Native Memory Metrics**: Expose specialized metrics for `jdk.foreign.memory` (if available) or manual metrics for allocated Off-Heap arenas to detect leaks.
4. **Dashboard**: A basic Grafana dashboard visualizing Request Rate, Error Rate, and Latency.

## Tasks / Subtasks
- [ ] **Dependencies**
    - [ ] Add `io.micrometer:micrometer-registry-prometheus`.
    - [ ] Add `io.micrometer:micrometer-tracing-bridge-otel`.
- [ ] **Log Configuration**
    - [ ] Configure Logback to output JSON (production) or Pattern (dev) containing `traceId`.
- [ ] **Kafka Instrumentation**
    - [ ] Enable Kafka interceptors for trace propagation.
- [ ] **Custom Metrics**
    - [ ] Register a `Gauge` to track the size of the Off-Heap Arena (mapped to the Biometric Store size).

## Dev Notes
* **Virtual Threads**: Ensure tracing context survives thread switching (Spring Boot 3.4+ handles this, but verify).